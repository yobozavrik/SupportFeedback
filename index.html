<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Зворотний зв'язок | Галя Балувана</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    <link rel="dns-prefetch" href="//fonts.gstatic.com">
    <link rel="dns-prefetch" href="//cdn.tailwindcss.com">
    <meta name="color-scheme" content="light dark">
    <script>
        tailwind.config = {
            darkMode: 'class'
        };
    </script>
    <script>
        (function () {
            try {
                const storedTheme = localStorage.getItem('gala-theme');
                const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (storedTheme === 'dark' || (!storedTheme && prefersDark)) {
                    document.documentElement.classList.add('dark');
                }
            } catch (error) {
                console.warn('Unable to apply stored theme preference.', error);
            }
        })();
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #fff7ed 0%, #fff1e1 100%);
            transition: background 0.3s ease, color 0.3s ease;
        }
        html.dark body {
            background: linear-gradient(135deg, #0f172a 0%, #1f2937 100%);
        }
        .glassmorphism {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        html.dark .glassmorphism {
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(148, 163, 184, 0.2);
            box-shadow: 0 25px 50px -12px rgba(15, 23, 42, 0.65);
        }
        .modal-enter { animation: fadeIn 0.3s ease-out forwards; }
        .modal-leave { animation: fadeOut 0.3s ease-in forwards; }
        .toast-enter { animation: slideInUp 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        .toast-leave { animation: slideOutDown 0.5s cubic-bezier(0.55, 0.085, 0.68, 0.53) forwards; }
        .content-enter { animation: fadeInUp 0.5s ease-out forwards; }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }
        @keyframes slideInUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes slideOutDown {
            from { transform: translateY(0); opacity: 1; }
            to { transform: translateY(100%); opacity: 0; }
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #f97316;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        .ai-loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #f97316;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #product-suggestions div:hover {
            background-color: #f97316;
            color: white;
        }
        html.dark #product-suggestions {
            background-color: rgba(15, 23, 42, 0.95);
            border-color: rgba(71, 85, 105, 0.6);
            color: #e2e8f0;
        }
        html.dark #product-suggestions div:hover {
            background-color: #f97316;
            color: #0f172a;
        }
        .star-rating .star { color: #d1d5db; transition: color 0.2s; }
        .star-rating .star.selected, .star-rating:hover .star:hover ~ .star, .star-rating:hover .star:hover { color: #f59e0b; }
        .star-rating:hover .star { color: #f59e0b; }
        .faq-question svg { transition: transform 0.3s ease; }
        .faq-question.open svg { transform: rotate(180deg); }
        .achievement-progress-bar { background-color: #e5e7eb; border-radius: 9999px; height: 8px; width: 100%; overflow: hidden; }
        .achievement-progress { background-color: #22c55e; height: 100%; transition: width 0.5s ease-in-out; }
        .category-btn:active {
            transform: translateY(-1px) scale(0.98);
        }
        html.dark .achievement-progress-bar {
            background-color: rgba(148, 163, 184, 0.2);
        }
        .toast-message {
            width: 100%;
            max-width: 20rem;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.4);
            color: #f8fafc;
        }
        .toast-success {
            background-color: #22c55e;
        }
        .toast-achievement {
            background-color: #facc15;
            color: #1f2937;
        }
        html.dark .toast-message {
            box-shadow: 0 25px 50px -12px rgba(15, 23, 42, 0.75);
        }
        html.dark .toast-success {
            background-color: #15803d;
        }
        html.dark .toast-achievement {
            color: #0f172a;
        }
        /* Performance: avoid painting offscreen content until needed */
        .cv-auto { content-visibility: auto; contain-intrinsic-size: 1px 600px; }
        /* Accessibility/perf: respect reduced motion */
        @media (prefers-reduced-motion: reduce) {
            * { animation: none !important; transition: none !important; }
        }
        .theme-toggle {
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
        /* Honeypot field for bots */
        .hp-field { position: absolute; left: -10000px; top: auto; width: 1px; height: 1px; overflow: hidden; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-orange-50 text-gray-800 dark:bg-slate-950 dark:text-gray-100 transition-colors duration-300">

    <div class="container mx-auto max-w-lg min-h-screen flex flex-col items-center gap-8 px-4 py-8">

        <div class="w-full flex justify-end gap-2">
            <button id="theme-toggle" type="button" class="theme-toggle glassmorphism flex items-center gap-2 rounded-full border border-orange-100 dark:border-slate-700 bg-white/70 dark:bg-slate-900/70 px-3 py-1.5 text-sm font-medium text-orange-600 dark:text-orange-300 transition-colors duration-300" aria-pressed="false">
                <span class="sr-only">Змінити тему</span>
                <svg id="theme-toggle-sun" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2m0 14v2m9-9h-2M5 12H3m15.364 6.364-1.414-1.414M7.05 7.05L5.636 5.636m12.728 0-1.414 1.414M7.05 16.95l-1.414 1.414M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
                <svg id="theme-toggle-moon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 12.79A9 9 0 1111.21 3a7 7 0 009.79 9.79z" />
                </svg>
                <span id="theme-toggle-label">Темна тема</span>
            </button>
        </div>

        <header class="text-center mb-8 content-enter" style="animation-delay: 100ms;">
            <h1 class="text-4xl font-bold text-[#8B4513] dark:text-orange-300 mb-2">Галя Балувана</h1>
            <p class="text-gray-600 dark:text-gray-300 mt-2">Ми цінуємо вашу думку! Залиште відгук.</p>
        </header>

        <main class="w-full content-enter" style="animation-delay: 200ms;">
            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                
                <button data-category="Скарга" class="category-btn glassmorphism p-6 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 flex flex-col items-center justify-center">
                    <div class="w-14 h-14 mb-2 rounded-full bg-red-500 flex items-center justify-center text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>
                    </div>
                    <span class="font-semibold text-gray-700 dark:text-gray-200">Скарга</span>
                </button>

                <button data-category="Немає продукції" class="category-btn glassmorphism p-6 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 flex flex-col items-center justify-center">
                     <div class="w-14 h-14 mb-2 rounded-full bg-blue-500 flex items-center justify-center text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" /></svg>
                    </div>
                    <span class="font-semibold text-gray-700 dark:text-gray-200">Немає продукції</span>
                </button>

                <button data-category="Пропозиція" class="category-btn glassmorphism p-6 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 flex flex-col items-center justify-center">
                    <div class="w-14 h-14 mb-2 rounded-full bg-yellow-500 flex items-center justify-center text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor" class="w-7 h-7">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v4"/>
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 17h.01"/>
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 3.75a8.25 8.25 0 1 1 0 16.5 8.25 8.25 0 0 1 0-16.5"/>
                        </svg>
                    </div>
                    <span class="font-semibold text-gray-700 dark:text-gray-200">Пропозиція</span>
                </button>

                <button data-category="Співпраця" class="category-btn glassmorphism p-6 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 flex flex-col items-center justify-center">
                    <div class="w-14 h-14 mb-2 rounded-full bg-green-500 flex items-center justify-center text-white">
                         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg>
                    </div>
                    <span class="font-semibold text-gray-700 dark:text-gray-200">Співпраця</span>
                </button>

                <button data-category="Подякувати продавцю" class="col-span-2 category-btn glassmorphism p-6 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 flex flex-col items-center justify-center">
                    <div class="w-14 h-14 mb-2 rounded-full bg-pink-500 flex items-center justify-center text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor" class="w-7 h-7">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" />
                        </svg>
                    </div>
                    <span class="font-semibold text-gray-700 dark:text-gray-200">Подякувати продавцю</span>
                </button>
            </div>
        </main>

        <section id="faq-section" class="w-full mt-8 glassmorphism p-6 rounded-2xl shadow-lg content-enter cv-auto" style="animation-delay: 300ms;">
            <h2 class="text-xl font-bold text-center mb-4 text-gray-800 dark:text-gray-100">Часті запитання</h2>
            <div class="space-y-2">
                <div class="faq-item">
                    <button class="faq-question w-full flex justify-between items-center text-left font-semibold p-3 rounded-lg hover:bg-white/50 dark:hover:bg-white/10 transition">
                        <span>Як дізнатися склад продукту?</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="faq-answer hidden p-3 pt-0 text-gray-600 dark:text-gray-300">
                        <p>Повний склад кожного продукту вказаний на етикетці. Також ви можете запитати у наших продавців-консультантів у магазині.</p>
                    </div>
                </div>
                 <div class="faq-item">
                    <button class="faq-question w-full flex justify-between items-center text-left font-semibold p-3 rounded-lg hover:bg-white/50 dark:hover:bg-white/10 transition">
                        <span>Де знайти найближчий магазин?</span>
                         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="faq-answer hidden p-3 pt-0 text-gray-600 dark:text-gray-300">
                        <p>Карта всіх наших магазинів доступна в офіційному додатку. Ми постійно розширюємо нашу мережу, щоб бути ближчими до вас.</p>
                    </div>
                </div>
            </div>
        </section>

        <footer class="w-full mt-auto pt-8 text-center content-enter cv-auto" style="animation-delay: 400ms;">
            <div class="flex justify-center items-center space-x-6 mb-4">
                <a href="https://www.instagram.com/galiabaluvana.chernivtsi" target="_blank" rel="noopener noreferrer" class="text-gray-500 dark:text-gray-300 hover:text-orange-600 dark:hover:text-orange-400 transition-colors duration-300 flex flex-col items-center">
                    <svg class="w-7 h-7" viewBox="0 0 448 512" aria-hidden="true" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <radialGradient id="instagram-gradient-footer" cx="50%" cy="50%" r="75%" fx="50%" fy="50%">
                                <stop offset="0%" stop-color="#fdf497" />
                                <stop offset="25%" stop-color="#fdf497" />
                                <stop offset="45%" stop-color="#fd5949" />
                                <stop offset="60%" stop-color="#d6249f" />
                                <stop offset="90%" stop-color="#285AEB" />
                            </radialGradient>
                        </defs>
                        <path fill="url(#instagram-gradient-footer)" d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9 287.7 141 224.1 141zm0 189.6c-41.1 0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7 74.7 33.5 74.7 74.7-33.6 74.7-74.7 74.7zm146.4-194.3c0 14.9-12 26.8-26.8 26.8-14.9 0-26.8-12-26.8-26.8s12-26.8 26.8-26.8 26.8 12 26.8 26.8zm76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8z" />
                        <g transform="translate(0 32)">
                            <g transform="scale(3.39394)">
                                <path fill="#fff" d="M66.004 18c-13.036 0-14.672.057-19.792.29-5.11.234-8.598 1.043-11.65 2.23-3.157 1.226-5.835 2.866-8.503 5.535-2.67 2.668-4.31 5.346-5.54 8.502-1.19 3.053-2 6.542-2.23 11.65C18.06 51.327 18 52.964 18 66s.058 14.667.29 19.787c.235 5.11 1.044 8.598 2.23 11.65 1.227 3.157 2.867 5.835 5.536 8.503 2.667 2.67 5.345 4.314 8.5 5.54 3.054 1.187 6.543 1.996 11.652 2.23 5.12.233 6.755.29 19.79.29 13.037 0 14.668-.057 19.788-.29 5.11-.234 8.602-1.043 11.656-2.23 3.156-1.226 5.83-2.87 8.497-5.54 2.67-2.668 4.31-5.346 5.54-8.502 1.18-3.053 1.99-6.542 2.23-11.65.23-5.12.29-6.752.29-19.788 0-13.036-.06-14.672-.29-19.792-.24-5.11-1.05-8.598-2.23-11.65-1.23-3.157-2.87-5.835-5.54-8.503-2.67-2.67-5.34-4.31-8.5-5.535-3.06-1.187-6.55-1.996-11.66-2.23-5.12-.233-6.75-.29-19.79-.29zm-4.306 8.65c1.278-.002 2.704 0 4.306 0 12.816 0 14.335.046 19.396.276 4.68.214 7.22.996 8.912 1.653 2.24.87 3.837 1.91 5.516 3.59 1.68 1.68 2.72 3.28 3.592 5.52.657 1.69 1.44 4.23 1.653 8.91.23 5.06.28 6.58.28 19.39s-.05 14.33-.28 19.39c-.214 4.68-.996 7.22-1.653 8.91-.87 2.24-1.912 3.835-3.592 5.514-1.68 1.68-3.275 2.72-5.516 3.59-1.69.66-4.232 1.44-8.912 1.654-5.06.23-6.58.28-19.396.28-12.817 0-14.336-.05-19.396-.28-4.68-.216-7.22-.998-8.913-1.655-2.24-.87-3.84-1.91-5.52-3.59-1.68-1.68-2.72-3.276-3.592-5.517-.657-1.69-1.44-4.23-1.653-8.91-.23-5.06-.276-6.58-.276-19.398s.046-14.33.276-19.39c.214-4.68.996-7.22 1.653-8.912.87-2.24 1.912-3.84 3.592-5.52 1.68-1.68 3.28-2.72 5.52-3.592 1.692-.66 4.233-1.44 8.913-1.655 4.428-.2 6.144-.26 15.09-.27zm29.928 7.97c-3.18 0-5.76 2.577-5.76 5.758 0 3.18 2.58 5.76 5.76 5.76 3.18 0 5.76-2.58 5.76-5.76 0-3.18-2.58-5.76-5.76-5.76zm-25.622 6.73c-13.613 0-24.65 11.037-24.65 24.65 0 13.613 11.037 24.645 24.65 24.645 13.613 0 24.646-11.032 24.646-24.645 0-13.613-11.034-24.65-24.647-24.65zm0 8.65c8.836 0 16 7.163 16 16 0 8.836-7.164 16-16 16-8.837 0-16-7.164-16-16 0-8.837 7.163-16 16-16z" />
                            </g>
                        </g>
                    </svg>
                    <span class="mt-1 text-xs">Instagram</span>
                </a>
                <button id="achievements-btn" class="text-gray-500 dark:text-gray-300 hover:text-orange-600 dark:hover:text-orange-400 transition-colors duration-300 flex flex-col items-center">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg>
                    <span class="mt-1 text-xs">Мої досягнення</span>
                </button>
                <a href="#" target="_blank" rel="noopener noreferrer" class="text-gray-500 dark:text-gray-300 hover:text-orange-600 dark:hover:text-orange-400 transition-colors duration-300 flex flex-col items-center">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                    <span class="mt-1 text-xs">Наш додаток</span>
                </a>
            </div>
            <p class="mt-4 text-xs text-gray-400 dark:text-gray-500">© 2025 Галя Балувана. Всі права захищені.</p>
        </footer>
    </div>

    <!-- Feedback Modal -->
    <div id="feedback-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="modal-title" tabindex="-1">
        <div class="glassmorphism rounded-2xl shadow-xl w-full max-w-md p-6 md:p-8 overflow-y-auto max-h-screen cv-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modal-title" class="text-2xl font-bold text-gray-800 dark:text-gray-100"></h2>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 dark:text-gray-400 dark:hover:text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <form id="feedback-form">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2">Наскільки ви задоволені?</label>
                    <div id="satisfaction-rating" class="star-rating flex items-center justify-center text-4xl cursor-pointer" data-rating="0">
                        <span class="star" data-value="1">★</span>
                        <span class="star" data-value="2">★</span>
                        <span class="star" data-value="3">★</span>
                        <span class="star" data-value="4">★</span>
                        <span class="star" data-value="5">★</span>
                    </div>
                </div>
                
                <!-- 1. НОВИЙ БЛОК: ВИПАДАЮЧИЙ СПИСОК ДЛЯ ПРИЧИНИ СКАРГИ -->
                <div id="complaint-reason-section" class="hidden mb-4">
                    <label for="complaint-reason-select" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">Причина скарги:</label>
                    <select id="complaint-reason-select" class="w-full p-3 border border-gray-300 dark:border-slate-700 dark:bg-slate-900 dark:text-gray-100 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition">
                        <option>Якість продукту (смак, запах, вигляд)</option>
                        <option>Термін придатності</option>
                        <option>Обслуговування персоналу</option>
                        <option>Чистота в магазині</option>
                        <option>Неправильний цінник / вага</option>
                        <option>Інше (описати в повідомленні)</option>
                    </select>
                </div>

                <!-- 2. ОНОВЛЕНИЙ БЛОК: ПОЛЕ ПРОДУКТУ ДЛЯ "НЕМАЄ ПРОДУКЦІЇ" -->
                <div id="product-input-section" class="hidden mb-4 relative">
                    <label for="product-input" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">Продукт:</label>
                    <input type="text" id="product-input" class="w-full p-3 border border-gray-300 dark:border-slate-700 dark:bg-slate-900 dark:text-gray-100 dark:placeholder-gray-400 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition" placeholder="Почніть вводити назву...">
                    <div id="product-suggestions" class="absolute z-10 w-full bg-white dark:bg-slate-900 border border-gray-300 dark:border-slate-700 rounded-b-lg mt-1 max-h-40 overflow-y-auto shadow-lg hidden"></div>
                </div>

                <div class="mb-4">
                    <div class="flex justify-between items-center mb-1">
                        <label for="feedback-text" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Ваше повідомлення:</label>
                        <button type="button" id="ai-assist-btn" class="text-xs text-orange-600 hover:text-orange-800 font-semibold flex items-center gap-1">
                            <span id="ai-assist-btn-text">✨ Допомога AI</span>
                            <div id="ai-assist-loader" class="ai-loader hidden"></div>
                        </button>
                    </div>
                    <textarea id="feedback-text" rows="5" class="w-full p-3 border border-gray-300 dark:border-slate-700 dark:bg-slate-900 dark:text-gray-100 dark:placeholder-gray-400 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition" placeholder="Опишіть детальніше..." required></textarea>
                    <div class="mt-1 text-xs text-gray-500 dark:text-gray-400 flex justify-between">
                        <span id="feedback-hint">Мін. 15 символів</span>
                        <span id="feedback-counter">0 / 800</span>
                    </div>
                </div>

                <div id="ai-results-section" class="hidden mb-4 p-3 bg-orange-50 dark:bg-slate-900/70 rounded-lg border border-orange-200 dark:border-orange-500/40">
                    <p class="text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">Аналіз від AI:</p>
                    <div id="ai-sentiment" class="text-sm mb-2"></div>
                    <div id="ai-summary" class="text-sm mb-2"></div>
                    <div>
                        <p class="text-xs font-medium text-gray-600 dark:text-gray-300 mb-1">Що можна додати:</p>
                        <ul id="ai-suggestions" class="list-disc list-inside text-xs text-gray-500 dark:text-gray-300 space-y-1"></ul>
                    </div>
                </div>
                
                <div id="photo-upload-section" class="hidden mb-4">
                     <label for="photo-upload-btn" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">Прикріпити фото:</label>
                    <input type="file" id="photo-upload-input" class="hidden" accept="image/*">
                     <button type="button" id="photo-upload-btn" class="w-full flex items-center justify-center gap-2 p-3 border-2 border-dashed border-gray-300 dark:border-slate-700 dark:bg-slate-900 dark:text-gray-300 rounded-lg text-gray-500 hover:bg-gray-50 dark:hover:bg-slate-800 hover:border-orange-500 hover:text-orange-600 dark:hover:text-orange-400 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                          <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <span>Зробити фото або обрати файл</span>
                     </button>
                     <div id="photo-preview-container" class="mt-4 hidden">
                         <img id="photo-preview" src="" alt="Photo preview" class="max-h-40 rounded-lg mx-auto" loading="lazy" decoding="async"/>
                     </div>
                </div>
                
                <div class="mb-6">
                    <label for="phone-input" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">Ваш телефон (необов'язково):</label>
                    <input type="tel" id="phone-input" class="w-full p-3 border border-gray-300 dark:border-slate-700 dark:bg-slate-900 dark:text-gray-100 dark:placeholder-gray-400 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition" placeholder="Для зворотного зв'язку" inputmode="tel" pattern="[0-9+ ()-]{7,20}">
                </div>

                <div class="mb-6 flex items-start">
                    <div class="flex items-center h-5">
                        <input id="consent-checkbox" name="consent" type="checkbox" class="focus:ring-orange-500 h-4 w-4 text-orange-600 border-gray-300 dark:border-slate-600 rounded" required>
                    </div>
                    <div class="ml-3 text-sm">
                        <label for="consent-checkbox" class="font-medium text-gray-700 dark:text-gray-200">Я даю згоду на обробку моїх персональних даних.</label>
                    </div>
                </div>

                <!-- Honeypot (должно оставаться пустым) -->
                <div class="hp-field" aria-hidden="true">
                    <label for="website">Website</label>
                    <input type="text" id="website" name="website" tabindex="-1" autocomplete="off">
                </div>

                <button id="submit-btn" type="submit" class="w-full bg-orange-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-orange-600 transition-colors duration-300 flex items-center justify-center">
                    <span id="submit-btn-text">Відправити</span>
                    <div id="submit-loader" class="loader hidden"></div>
                </button>
            </form>
        </div>
    </div>

     <!-- Achievements Modal -->
    <div id="achievements-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="achievements-title" tabindex="-1">
        <div class="glassmorphism rounded-2xl shadow-xl w-full max-w-md p-6 md:p-8 cv-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 id="achievements-title" class="text-2xl font-bold text-gray-800 dark:text-gray-100">Мої досягнення</h2>
                <button id="close-achievements-modal-btn" class="text-gray-400 hover:text-gray-600 dark:text-gray-400 dark:hover:text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div id="achievements-list" class="space-y-4">
                <!-- Achievements will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 z-50">
        <!-- Toast messages will be injected here -->
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Service Worker registration
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').catch(console.warn);
            }
            // --- CONFIGURATION ---
            // ВЕБХУК: всегда прод-режим
            let N8N_WEBHOOK_URL = 'https://n8n.dmytrotovstytskyi.online/webhook/supporttest';
            const GEMINI_API_KEY = ''; // The build environment will provide this key.
            const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
            const MOCK_PRODUCT_LIST = [
                "Пельмені зі свининою", "Пельмені з яловичиною", "Пельмені з куркою", "Пельмені дитячі",
                "Вареники з картоплею", "Вареники з капустою", "Вареники з вишнею", "Вареники з сиром солодкі",
                "Хінкалі", "Равіолі", "Млинці з м'ясом", "Млинці з сиром", "Сирники", "Котлети домашні",
                "Голубці", "Перець фарширований", "Чебуреки", "Борщ", "Суп-харчо"
            ];
            const SECRET_SHOPPER_GOAL = 3;

            // --- DOM ELEMENTS ---
            const categoryButtons = document.querySelectorAll('.category-btn');
            const modal = document.getElementById('feedback-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const modalTitle = document.getElementById('modal-title');
            const feedbackForm = document.getElementById('feedback-form');
            const toastContainer = document.getElementById('toast');
            const faqItems = document.querySelectorAll('.faq-item');
            const achievementsBtn = document.getElementById('achievements-btn');
            const achievementsModal = document.getElementById('achievements-modal');
            const closeAchievementsModalBtn = document.getElementById('close-achievements-modal-btn');
            const achievementsList = document.getElementById('achievements-list');
            const themeToggleBtn = document.getElementById('theme-toggle');
            const themeToggleSun = document.getElementById('theme-toggle-sun');
            const themeToggleMoon = document.getElementById('theme-toggle-moon');
            const themeToggleLabel = document.getElementById('theme-toggle-label');
            const prefersDarkMedia = window.matchMedia ? window.matchMedia('(prefers-color-scheme: dark)') : null;

            const THEME_STORAGE_KEY = 'gala-theme';
            
            // --- STATE ---
            let currentCategory = '';
            let selectedFile = null;
            let storeId = 'unknown_store';
            let satisfactionRating = 0;
            let userGeolocation = null;
            let userId = null;
            let userAchievements = null;
            let lastFocusedElement = null;
            // Anti-spam state
            const MIN_TEXT_LEN = 15;
            const MAX_TEXT_LEN = 800;
            const SUBMIT_COOLDOWN_MS = 15000; // 15s
            const PER_USER_RATE_LIMIT = { windowMs: 60_000, max: 5 }; // 5 отправок в минуту
            const STORAGE_LAST_SUBMIT = 'gala-last-submit';
            const STORAGE_SUBMIT_WINDOW = 'gala-submit-window';
            const STORAGE_SUBMIT_COUNT = 'gala-submit-count';

            const getStoredTheme = () => {
                try {
                    return localStorage.getItem(THEME_STORAGE_KEY);
                } catch (error) {
                    console.warn('Unable to read stored theme preference.', error);
                    return null;
                }
            };

            const storeTheme = (theme) => {
                try {
                    localStorage.setItem(THEME_STORAGE_KEY, theme);
                } catch (error) {
                    console.warn('Unable to persist theme preference.', error);
                }
            };

            const applyTheme = (theme, options = {}) => {
                const { persist = true } = options;
                const themeToApply = theme === 'dark' ? 'dark' : 'light';
                const root = document.documentElement;
                const isDark = themeToApply === 'dark';
                root.classList.toggle('dark', isDark);

                if (themeToggleBtn) {
                    themeToggleBtn.setAttribute('aria-pressed', String(isDark));
                }
                if (themeToggleSun && themeToggleMoon) {
                    themeToggleSun.classList.toggle('hidden', !isDark);
                    themeToggleMoon.classList.toggle('hidden', isDark);
                }
                if (themeToggleLabel) {
                    themeToggleLabel.textContent = isDark ? 'Світла тема' : 'Темна тема';
                }

                if (persist) {
                    storeTheme(themeToApply);
                }
            };

            const initializeTheme = () => {
                const storedTheme = getStoredTheme();
                if (storedTheme === 'dark' || storedTheme === 'light') {
                    applyTheme(storedTheme, { persist: false });
                } else {
                    const prefersDark = prefersDarkMedia ? prefersDarkMedia.matches : false;
                    applyTheme(prefersDark ? 'dark' : 'light', { persist: false });
                }

                if (themeToggleBtn) {
                    themeToggleBtn.addEventListener('click', () => {
                        const nextTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
                        applyTheme(nextTheme);
                    });
                }

                if (prefersDarkMedia) {
                    const syncWithSystem = (event) => {
                        if (!getStoredTheme()) {
                            applyTheme(event.matches ? 'dark' : 'light', { persist: false });
                        }
                    };
                    if (typeof prefersDarkMedia.addEventListener === 'function') {
                        prefersDarkMedia.addEventListener('change', syncWithSystem);
                    } else if (typeof prefersDarkMedia.addListener === 'function') {
                        prefersDarkMedia.addListener(syncWithSystem);
                    }
                }
            };

            // --- INITIALIZATION ---
            const initializeUser = () => {
                userId = localStorage.getItem('gala-userId');
                if (!userId) {
                    userId = crypto.randomUUID();
                    localStorage.setItem('gala-userId', userId);
                }

                const achievementsData = localStorage.getItem('gala-userAchievements');
                if (!achievementsData) {
                    userAchievements = {
                        secretShopper: { earned: false, stores: [] }
                    };
                    localStorage.setItem('gala-userAchievements', JSON.stringify(userAchievements));
                } else {
                    userAchievements = JSON.parse(achievementsData);
                }
            };
            
            const urlParams = new URLSearchParams(window.location.search);
            storeId = urlParams.get('store_id') || 'unknown_store';
            initializeUser();
            initializeTheme();


            // --- FUNCTIONS ---
            const getGeolocation = () => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            userGeolocation = {
                                latitude: position.coords.latitude,
                                longitude: position.coords.longitude,
                            };
                        },
                        (error) => {
                            console.warn(`Geolocation error: ${error.message}`);
                            userGeolocation = null;
                        }
                    );
                }
            };

            const openModal = (category) => {
                currentCategory = category;
                modalTitle.textContent = category;
                
                const productInputSection = document.getElementById('product-input-section');
                const complaintReasonSection = document.getElementById('complaint-reason-section');
                const photoUploadSection = document.getElementById('photo-upload-section');

                productInputSection.classList.add('hidden');
                complaintReasonSection.classList.add('hidden');
                photoUploadSection.classList.add('hidden');

                if (category === 'Скарга') {
                    complaintReasonSection.classList.remove('hidden');
                    photoUploadSection.classList.remove('hidden');
                }

                if (category === 'Немає продукції') {
                    productInputSection.classList.remove('hidden');
                }

                modal.classList.remove('hidden');
                modal.classList.add('modal-enter');
                modal.classList.remove('modal-leave');
                setupFocusTrap(modal);
                focusFirstElement(modal);
                getGeolocation();
            };

            const closeModal = (modalElement) => {
                modalElement.classList.add('modal-leave');
                modalElement.classList.remove('modal-enter');
                setTimeout(() => {
                    modalElement.classList.add('hidden');
                    if (modalElement.id === 'feedback-modal') {
                        resetForm();
                    }
                    releaseFocusTrap();
                    if (lastFocusedElement && typeof lastFocusedElement.focus === 'function') {
                        lastFocusedElement.focus();
                    }
                }, 300);
            };

            const resetForm = () => {
                feedbackForm.reset();
                document.getElementById('product-input-section').classList.add('hidden');
                document.getElementById('complaint-reason-section').classList.add('hidden');
                document.getElementById('photo-upload-section').classList.add('hidden');
                document.getElementById('photo-preview-container').classList.add('hidden');
                document.getElementById('ai-results-section').classList.add('hidden');
                document.getElementById('product-suggestions').innerHTML = '';
                document.getElementById('product-suggestions').classList.add('hidden');
                document.getElementById('photo-preview').src = '';
                const complaintReasonSelect = document.getElementById('complaint-reason-select');
                if (complaintReasonSelect) {
                    complaintReasonSelect.selectedIndex = 0;
                }
                selectedFile = null;
                currentCategory = '';
                satisfactionRating = 0;
                userGeolocation = null;
                updateStarRating(0);
                updateFeedbackCounter(0);
            };
            
            // ---- Image helpers: resize/compress ----
            const fileToArrayBuffer = (blob) => new Promise((resolve, reject) => {
                const fr = new FileReader();
                fr.onload = () => resolve(fr.result);
                fr.onerror = reject;
                fr.readAsArrayBuffer(blob);
            });
            const fileToDataURL = (blob) => new Promise((resolve, reject) => {
                const fr = new FileReader();
                fr.onload = () => resolve(fr.result);
                fr.onerror = reject;
                fr.readAsDataURL(blob);
            });
            const loadImageBitmap = async (blob) => {
                if ('createImageBitmap' in window) {
                    try { return await createImageBitmap(blob); } catch (e) { /* fallthrough */ }
                }
                // Fallback via HTMLImageElement
                return await new Promise((resolve, reject) => {
                    const url = URL.createObjectURL(blob);
                    const img = new Image();
                    img.onload = () => { URL.revokeObjectURL(url); resolve(img); };
                    img.onerror = (e) => { URL.revokeObjectURL(url); reject(e); };
                    img.src = url;
                });
            };
            const resizeImageBlob = async (blob, { maxSize = 1600, quality = 0.82 } = {}) => {
                try {
                    const bitmap = await loadImageBitmap(blob);
                    const w = bitmap.width || bitmap.naturalWidth;
                    const h = bitmap.height || bitmap.naturalHeight;
                    if (!w || !h) return null;
                    let targetW = w, targetH = h;
                    if (Math.max(w, h) > maxSize) {
                        const scale = maxSize / Math.max(w, h);
                        targetW = Math.round(w * scale);
                        targetH = Math.round(h * scale);
                    }
                    const canvas = document.createElement('canvas');
                    canvas.width = targetW; canvas.height = targetH;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(bitmap, 0, 0, targetW, targetH);
                    const blobOut = await new Promise((resolve) => canvas.toBlob(resolve, 'image/jpeg', quality));
                    return blobOut;
                } catch (_) {
                    return null;
                }
            };

            const handleFileSelect = async (event) => {
                const file = event.target.files[0];
                if (file) {
                    const isImage = file.type && file.type.startsWith('image/');
                    const maxSizeBytes = 5 * 1024 * 1024; // 5MB
                    if (!isImage) {
                        alert('Пожалуйста, выберите файл изображения.');
                        event.target.value = '';
                        return;
                    }
                    if (file.size > maxSizeBytes) {
                        alert('Файл слишком большой. Максимум 5 МБ.');
                        event.target.value = '';
                        return;
                    }
                    // Magic bytes validation
                    const ab = await fileToArrayBuffer(file.slice(0, 16));
                    const bytes = new Uint8Array(ab);
                    const isJPEG = bytes[0] === 0xFF && bytes[1] === 0xD8 && bytes[2] === 0xFF;
                    const isPNG = bytes[0] === 0x89 && bytes[1] === 0x50 && bytes[2] === 0x4E && bytes[3] === 0x47;
                    const isWEBP = bytes[0] === 0x52 && bytes[1] === 0x49 && bytes[2] === 0x46 && bytes[3] === 0x46 && bytes[8] === 0x57 && bytes[9] === 0x45 && bytes[10] === 0x42 && bytes[11] === 0x50;
                    const isHEIC = bytes[4] === 0x66 && bytes[5] === 0x74 && bytes[6] === 0x79 && bytes[7] === 0x70;
                    if (!(isJPEG || isPNG || isWEBP || isHEIC)) {
                        alert('Неподдерживаемый формат. Разрешены JPEG/PNG/WEBP/HEIC.');
                        event.target.value = '';
                        return;
                    }

                    // Resize/compress if beneficial
                    let finalBlob = file;
                    const resized = await resizeImageBlob(file, { maxSize: 1600, quality: 0.82 });
                    if (resized && resized.size > 0 && resized.size < file.size) {
                        finalBlob = new File([resized], `${file.name.replace(/\.[^.]+$/, '')}.jpg`, { type: 'image/jpeg' });
                    }
                    selectedFile = finalBlob;
                    const dataUrl = await fileToDataURL(finalBlob);
                    document.getElementById('photo-preview').src = dataUrl;
                    document.getElementById('photo-preview-container').classList.remove('hidden');
                }
            };
            
            const showLoading = (isLoading, element = 'submit') => {
                const btn = document.getElementById('submit-btn');
                const btnText = document.getElementById('submit-btn-text');
                const loader = document.getElementById('submit-loader');
                
                const aiBtn = document.getElementById('ai-assist-btn');
                const aiBtnText = document.getElementById('ai-assist-btn-text');
                const aiLoader = document.getElementById('ai-assist-loader');

                 if (element === 'submit') {
                    btnText.classList.toggle('hidden', isLoading);
                    loader.classList.toggle('hidden', !isLoading);
                    btn.disabled = isLoading;
                } else if (element === 'ai') {
                    aiBtnText.classList.toggle('hidden', isLoading);
                    aiLoader.classList.toggle('hidden', !isLoading);
                    aiBtn.disabled = isLoading;
                }
            };
            
            const showToast = (message, type = 'success') => {
                const toastId = `toast-${Date.now()}`;
                const icon = type === 'achievement' ? '🏆' : '✅';
                const toastElement = document.createElement('div');
                toastElement.id = toastId;
                const toneClass = type === 'achievement' ? 'toast-achievement' : 'toast-success';
                toastElement.className = `toast-message ${toneClass} toast-enter`;
                toastElement.innerHTML = `<p>${icon} ${message}</p>`;
                
                toastContainer.appendChild(toastElement);

                setTimeout(() => {
                    toastElement.classList.add('toast-leave');
                    toastElement.classList.remove('toast-enter');
                    setTimeout(() => toastElement.remove(), 500);
                }, 5000);
            };
            
            const getAiAnalysis = async (text) => {
                const systemPrompt = "Ти — доброзичливий AI-асистент компанії 'Галя Балувана'. Твоя мета — допомогти клієнтам написати чіткий та конструктивний відгук. Проаналізуй текст користувача та надай настрій відгуку, коротке резюме та три конкретні поради щодо покращення українською мовою. Відповідай ТІЛЬКИ у форматі JSON згідно зі схемою.";
                const payload = {
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    contents: [{ parts: [{ text }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                sentiment: { type: "STRING" },
                                summary: { type: "STRING" },
                                suggestions: { type: "ARRAY", items: { type: "STRING" } }
                            },
                            required: ["sentiment", "summary", "suggestions"]
                        }
                    }
                };
                
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error("Gemini API Error Response:", errorBody);
                    throw new Error('Не вдалося отримати відповідь від AI.');
                }
                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!jsonText) {
                   throw new Error('Відповідь AI має невірний формат.');
                }
                return JSON.parse(jsonText);
            };
            
            const postWithRetry = async (url, options, retryCfg = {}) => {
                const { retries = 2, timeoutMs = 10000, backoffMs = 800 } = retryCfg;
                let attempt = 0;
                let lastError = null;
                while (attempt <= retries) {
                    const controller = new AbortController();
                    const id = setTimeout(() => controller.abort(), timeoutMs);
                    try {
                        const resp = await fetch(url, { ...options, signal: controller.signal, credentials: 'omit', redirect: 'follow' });
                        clearTimeout(id);
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        return resp;
                    } catch (err) {
                        clearTimeout(id);
                        lastError = err;
                        if (attempt === retries) break;
                        await new Promise(r => setTimeout(r, backoffMs * Math.pow(2, attempt)));
                        attempt += 1;
                    }
                }
                throw lastError || new Error('Request failed');
            };

            // ---- Anti-spam helpers ----
            const updateFeedbackCounter = (len) => {
                const counterEl = document.getElementById('feedback-counter');
                if (counterEl) counterEl.textContent = `${len} / ${MAX_TEXT_LEN}`;
                const hintEl = document.getElementById('feedback-hint');
                if (hintEl) hintEl.textContent = len < MIN_TEXT_LEN ? `Мін. ${MIN_TEXT_LEN} символів` : 'Дякуємо за деталі!';
            };

            const isUnderCooldown = () => {
                const last = parseInt(localStorage.getItem(STORAGE_LAST_SUBMIT) || '0', 10);
                return Date.now() - last < SUBMIT_COOLDOWN_MS;
            };

            const canPassRateLimit = () => {
                const now = Date.now();
                const windowStart = parseInt(localStorage.getItem(STORAGE_SUBMIT_WINDOW) || '0', 10);
                let count = parseInt(localStorage.getItem(STORAGE_SUBMIT_COUNT) || '0', 10);
                if (now - windowStart > PER_USER_RATE_LIMIT.windowMs) {
                    localStorage.setItem(STORAGE_SUBMIT_WINDOW, String(now));
                    localStorage.setItem(STORAGE_SUBMIT_COUNT, '0');
                    count = 0;
                }
                return count < PER_USER_RATE_LIMIT.max;
            };

            const incrementRateCounter = () => {
                const now = Date.now();
                const windowStart = parseInt(localStorage.getItem(STORAGE_SUBMIT_WINDOW) || '0', 10);
                let count = parseInt(localStorage.getItem(STORAGE_SUBMIT_COUNT) || '0', 10);
                if (now - windowStart > PER_USER_RATE_LIMIT.windowMs) {
                    localStorage.setItem(STORAGE_SUBMIT_WINDOW, String(now));
                    count = 0;
                }
                localStorage.setItem(STORAGE_SUBMIT_COUNT, String(count + 1));
                localStorage.setItem(STORAGE_SUBMIT_WINDOW, windowStart ? String(windowStart) : String(now));
                localStorage.setItem(STORAGE_LAST_SUBMIT, String(now));
            };

            const handleSubmit = async (event) => {
                event.preventDefault();
                // Honeypot: если заполнено — блокируем
                const hp = document.getElementById('website');
                if (hp && hp.value && hp.value.trim().length > 0) {
                    alert('Помилка відправки.');
                    return;
                }
                // Минимальная задержка до отправки после открытия модалки
                // (простая эвристика против ботов)
                const openDelayOk = true; // можно расширить, если нужно
                if (!openDelayOk) return;

                const textEl = document.getElementById('feedback-text');
                const raw = (textEl.value || '').trim();
                // Простая санитаризация от опасных HTML/JS
                const textVal = raw
                    .replace(/[\u0000-\u001F\u007F]/g, '')
                    .replace(/<\s*script/gi, '&lt;script')
                    .replace(/on[a-z]+\s*=\s*"[^"]*"/gi, '')
                    .replace(/on[a-z]+\s*=\s*'[^']*'/gi, '')
                    .replace(/on[a-z]+\s*=\s*[^\s>]+/gi, '');
                if (textVal.length < MIN_TEXT_LEN) {
                    alert(`Будь ласка, додайте більше деталей (мінімум ${MIN_TEXT_LEN} символів).`);
                    return;
                }
                if (textVal.length > MAX_TEXT_LEN) {
                    alert(`Будь ласка, скоротіть повідомлення до ${MAX_TEXT_LEN} символів.`);
                    return;
                }
                if (isUnderCooldown()) {
                    alert('Занадто часті відправки. Будь ласка, зачекайте кілька секунд.');
                    return;
                }
                if (!canPassRateLimit()) {
                    alert('Досягнуто ліміт відправок. Спробуйте пізніше.');
                    return;
                }
                showLoading(true, 'submit');

                const applicationId = `GB-${Date.now().toString(36).toUpperCase()}`;
                const formData = new FormData();
                // client token: привязка к userId и времени
                const clientToken = btoa(`${userId}.${applicationId}.${storeId}.${Date.now()}`);

                formData.append('userId', userId);
                formData.append('applicationId', applicationId);
                formData.append('storeId', storeId);
                formData.append('clientToken', clientToken);
                formData.append('category', currentCategory);
                formData.append('rating', satisfactionRating);
                const productValue = currentCategory === 'Немає продукції' ? document.getElementById('product-input').value : '';
                const complaintReason = currentCategory === 'Скарга' ? document.getElementById('complaint-reason-select').value : '';
                formData.append('product', productValue || '');
                formData.append('complaintReason', complaintReason || '');
                formData.append('text', textVal);
                formData.append('phone', document.getElementById('phone-input').value || null);
                if (userGeolocation) {
                    formData.append('geolocation', JSON.stringify(userGeolocation));
                }
                if (selectedFile) {
                    formData.append('file', selectedFile);
                }

                try {
                    const response = await postWithRetry(N8N_WEBHOOK_URL, {
                        method: 'POST',
                        body: formData,
                    }, { retries: 2, timeoutMs: 12000, backoffMs: 600 });
                    
                    closeModal(modal);
                    showToast(`Дякуємо! Номер вашого звернення: ${applicationId}`);
                    trackStoreVisit(storeId);
                    incrementRateCounter();

                } catch (error) {
                    console.error('There was a problem:', error);
                    alert(`Виникла помилка під час відправки: ${error.message}. Спробуйте, будь ласка, ще раз.`);
                } finally {
                    showLoading(false, 'submit');
                }
            };
            
             const handleAiAssist = async () => {
                const text = document.getElementById('feedback-text').value;
                if (text.trim().length < 10) {
                    alert('Будь ласка, напишіть хоча б декілька слів для аналізу.');
                    return;
                }
                showLoading(true, 'ai');
                document.getElementById('ai-results-section').classList.add('hidden');

                try {
                    const analysis = await getAiAnalysis(text);
                    document.getElementById('ai-sentiment').textContent = `Настрій відгуку: ${analysis.sentiment || 'Не визначено'}`;
                    document.getElementById('ai-summary').textContent = `Ключова думка: ${analysis.summary || '–'}`;
                    const suggestionsEl = document.getElementById('ai-suggestions');
                    suggestionsEl.innerHTML = '';
                    (analysis.suggestions || []).forEach(suggestion => {
                        const li = document.createElement('li');
                        li.textContent = suggestion;
                        suggestionsEl.appendChild(li);
                    });
                    document.getElementById('ai-results-section').classList.remove('hidden');
                } catch (error) {
                    console.error('AI Assist Error:', error);
                    alert(`Помилка аналізу: ${error.message}`);
                } finally {
                    showLoading(false, 'ai');
                }
            };
            
            // Small perf win: debounce autocomplete
            const debounce = (fn, delay = 150) => {
                let t = null;
                return (...args) => {
                    if (t) clearTimeout(t);
                    t = setTimeout(() => fn(...args), delay);
                };
            };

            const handleProductAutocomplete = (event) => {
                const value = event.target.value.toLowerCase();
                const suggestionsEl = document.getElementById('product-suggestions');
                suggestionsEl.innerHTML = '';
                if (value.length < 2) {
                    suggestionsEl.classList.add('hidden');
                    return;
                }

                const filteredProducts = MOCK_PRODUCT_LIST.filter(p => p.toLowerCase().includes(value));

                if (filteredProducts.length > 0) {
                    suggestionsEl.classList.remove('hidden');
                    filteredProducts.forEach(product => {
                        const div = document.createElement('div');
                        div.textContent = product;
                        div.className = 'p-2 cursor-pointer transition-colors duration-200 text-gray-700 dark:text-gray-200';
                        div.onclick = () => {
                            document.getElementById('product-input').value = product;
                            suggestionsEl.innerHTML = '';
                            suggestionsEl.classList.add('hidden');
                        };
                        suggestionsEl.appendChild(div);
                    });
                } else {
                    suggestionsEl.classList.add('hidden');
                }
            };
            const handleProductAutocompleteDebounced = debounce(handleProductAutocomplete, 180);

            // --- ACCESSIBILITY: focus trap and Esc-close for modals ---
            let activeTrap = null;
            const getFocusableElements = (container) => {
                return container.querySelectorAll('a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])');
            };
            const focusFirstElement = (container) => {
                lastFocusedElement = document.activeElement;
                const focusables = getFocusableElements(container);
                if (focusables.length > 0) {
                    focusables[0].focus();
                } else {
                    container.focus();
                }
            };
            const handleKeydown = (e) => {
                if (!activeTrap) return;
                if (e.key === 'Escape') {
                    closeModal(activeTrap);
                    return;
                }
                if (e.key === 'Tab') {
                    const focusables = Array.from(getFocusableElements(activeTrap));
                    if (focusables.length === 0) return;
                    const first = focusables[0];
                    const last = focusables[focusables.length - 1];
                    if (e.shiftKey && document.activeElement === first) {
                        e.preventDefault();
                        last.focus();
                    } else if (!e.shiftKey && document.activeElement === last) {
                        e.preventDefault();
                        first.focus();
                    }
                }
            };
            const setupFocusTrap = (container) => {
                activeTrap = container;
                document.addEventListener('keydown', handleKeydown);
            };
            const releaseFocusTrap = () => {
                document.removeEventListener('keydown', handleKeydown);
                activeTrap = null;
            };

            const updateStarRating = (rating) => {
                document.querySelectorAll('#satisfaction-rating .star').forEach(star => {
                    star.classList.toggle('selected', star.dataset.value <= rating);
                });
            };

            const trackStoreVisit = (storeId) => {
                if (storeId === 'unknown_store' || !userAchievements.secretShopper) return;
                
                const { stores, earned } = userAchievements.secretShopper;
                if (!stores.includes(storeId)) {
                    stores.push(storeId);
                    userAchievements.secretShopper.stores = stores;
                    localStorage.setItem('gala-userAchievements', JSON.stringify(userAchievements));
                    checkSecretShopperAchievement();
                }
            };

            const checkSecretShopperAchievement = () => {
                const { stores, earned } = userAchievements.secretShopper;
                if (!earned && stores.length >= SECRET_SHOPPER_GOAL) {
                    userAchievements.secretShopper.earned = true;
                    localStorage.setItem('gala-userAchievements', JSON.stringify(userAchievements));
                    showToast("Ви отримали досягнення 'Таємний покупець'!", 'achievement');
                }
            };

            const renderAchievements = () => {
                const { stores, earned } = userAchievements.secretShopper;
                const progress = Math.min(stores.length, SECRET_SHOPPER_GOAL);
                const isCompleted = earned || progress >= SECRET_SHOPPER_GOAL;

                const achievementHTML = `
                    <div class="border rounded-lg p-4 ${isCompleted
                        ? 'bg-green-50 border-green-200 dark:bg-emerald-900/40 dark:border-emerald-500/40'
                        : 'bg-gray-50 border-gray-200 dark:bg-slate-900/60 dark:border-slate-700/60'}">
                        <div class="flex items-center">
                            <div class="text-4xl mr-4">${isCompleted ? '🏆' : '🕵️'}</div>
                            <div>
                                <h3 class="font-bold text-lg ${isCompleted ? 'text-green-700 dark:text-emerald-300' : 'text-gray-800 dark:text-gray-100'}">Таємний покупець</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-300">Залиште відгуки з ${SECRET_SHOPPER_GOAL} різних магазинів.</p>
                            </div>
                        </div>
                        <div class="mt-3">
                            <div class="flex justify-between text-sm font-medium ${isCompleted ? 'text-green-700 dark:text-emerald-300' : 'text-gray-700 dark:text-gray-200'} mb-1">
                                <span>Прогрес</span>
                                <span>${progress} / ${SECRET_SHOPPER_GOAL}</span>
                            </div>
                            <div class="achievement-progress-bar">
                                <div class="achievement-progress" style="width: ${(progress / SECRET_SHOPPER_GOAL) * 100}%"></div>
                            </div>
                        </div>
                    </div>
                `;
                achievementsList.innerHTML = achievementHTML;
            };

            const openAchievementsModal = () => {
                renderAchievements();
                achievementsModal.classList.remove('hidden');
                achievementsModal.classList.remove('modal-leave');
                achievementsModal.classList.add('modal-enter');
            };
            
            // --- EVENT LISTENERS BINDING ---
            categoryButtons.forEach(button => button.addEventListener('click', () => openModal(button.dataset.category)));
            closeModalBtn.addEventListener('click', () => closeModal(modal));
            modal.addEventListener('click', (e) => { if (e.target.id === 'feedback-modal') closeModal(modal); });
            
            achievementsBtn.addEventListener('click', openAchievementsModal);
            closeAchievementsModalBtn.addEventListener('click', () => closeModal(achievementsModal));
            achievementsModal.addEventListener('click', (e) => { if (e.target.id === 'achievements-modal') closeModal(achievementsModal); });

            faqItems.forEach(item => {
                const question = item.querySelector('.faq-question');
                const answer = item.querySelector('.faq-answer');
                question.addEventListener('click', () => {
                    answer.classList.toggle('hidden');
                    question.classList.toggle('open');
                });
            });

            feedbackForm.addEventListener('submit', handleSubmit);
            document.getElementById('ai-assist-btn').addEventListener('click', handleAiAssist);
            document.getElementById('photo-upload-btn').addEventListener('click', () => document.getElementById('photo-upload-input').click());
            document.getElementById('photo-upload-input').addEventListener('change', handleFileSelect);
            document.getElementById('product-input').addEventListener('input', handleProductAutocompleteDebounced);
            // live counter
            document.getElementById('feedback-text').addEventListener('input', (e) => {
                const val = (e.target.value || '').slice(0, MAX_TEXT_LEN);
                if (val !== e.target.value) e.target.value = val;
                updateFeedbackCounter(val.length);
            });
            const testToggleBtn = document.getElementById('test-toggle-btn');
            if (testToggleBtn) {
                testToggleBtn.addEventListener('click', () => {
                    const enabled = !!localStorage.getItem(STORAGE_TEST_KEY);
                    setTestMode(!enabled);
                    showToast(`Режим переключен: ${!enabled ? 'TEST' : 'PROD'}`);
                });
            }
            const persistentTestChip = document.getElementById('test-chip');
            if (persistentTestChip) {
                persistentTestChip.addEventListener('click', () => {
                    const enabled = !!localStorage.getItem(STORAGE_TEST_KEY);
                    setTestMode(!enabled);
                    showToast(`Режим переключен: ${!enabled ? 'TEST' : 'PROD'}`);
                });
            }
            
            document.querySelectorAll('#satisfaction-rating .star').forEach(star => {
                star.addEventListener('click', () => {
                    satisfactionRating = parseInt(star.dataset.value);
                    document.getElementById('satisfaction-rating').dataset.rating = satisfactionRating;
                    updateStarRating(satisfactionRating);
                });
                star.addEventListener('mouseover', () => {
                    const rating = parseInt(star.dataset.value);
                    updateStarRating(rating);
                });
            });
            document.getElementById('satisfaction-rating').addEventListener('mouseleave', () => {
                updateStarRating(satisfactionRating);
            });
        });
    </script>
</body>
</html>
